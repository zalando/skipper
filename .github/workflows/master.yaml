name: master
on:
  push:
    branches:
      - master
permissions: {}
env:
  TESTCONTAINERS_RYUK_DISABLED: true
jobs:
  tests:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
      - uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00
        with:
          # https://www.npmjs.com/package/semver#caret-ranges-123-025-004
          go-version: "^1.23"
          check-latest: true
      - run: go version
      - run: make deps
      - run: make check-fmt
      - run: make vet
      - run: make staticcheck
      - run: make osv-scanner
      - run: make govulncheck
      - run: make check-race
      - run: make capslock
      - run: make coverprofile
      - name: Convert coverage to lcov
        uses: jandelgado/gcov2lcov-action@e4612787670fc5b5f49026b8c29c5569921de1db
      - name: Coveralls
        uses: coverallsapp/github-action@648a8eb78e6d50909eff900e4ec85cab4524a45b
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: coverage.lcov
  alert-on-failure:
    runs-on: ubuntu-latest
    needs: [tests]
    if: ${{ failure() }}
    steps:
    - id: failed-name
      env:
        GH_TOKEN: ${{ github.token }}
      run: echo NAME=$(gh api /repos/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID/jobs | jq -r '.jobs[0].steps[]|select(.conclusion == "failure")|.name') >> "$GITHUB_OUTPUT"
    - id: job-id
      env:
        GH_TOKEN: ${{ github.token }}
      run: echo ID=$(gh api /repos/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID/jobs | jq -r '.jobs[0].id') >> "$GITHUB_OUTPUT"
    - id: thread-key
      run: echo KEY=$(date +"%d-%m-%y") >> "$GITHUB_OUTPUT"
    - run: >-
        curl
        -H 'content-type:application/json'
        "${{ secrets.INTERNAL_CHAT_WEBHOOK }}"
        -d "{
          \"thread\": {
              \"threadKey\": \"${{ steps.thread-key.outputs.KEY }}\"
            },
          \"cardsV2\": [
            {
              \"cardId\": \"skipper-failing-pipeline\",
              \"card\": {
                \"header\": {
                  \"title\": \"Build Failed\",
                  \"imageUrl\": \"https://raw.githubusercontent.com/zalando/skipper/master/img/skipper-h180.png\",
                  \"imageType\": \"CIRCLE\"
                },
                \"sections\": [
                  {
                    \"header\": \"Failed Step: ${{ steps.failed-name.outputs.NAME }}\",
                    \"collapsible\": false,
                    \"widgets\": [
                      {
                        \"buttonList\": {
                          \"buttons\": [
                            {
                              \"text\": \"View Build Logs\",
                              \"onClick\": {
                                \"openLink\": {
                                  \"url\": \"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID/job/${{ steps.job-id.outputs.ID}}\"
                                }
                              }
                            }
                          ]
                        }
                      }
                    ]
                  }
                ]
              }
            }
          ]
          }"
