version: "2017-09-20"
pipeline:
- id: build
  overlay: ci/golang
  type: script
  commands:
  - desc: build-push
    cmd: |
      if [[ $CDP_TARGET_BRANCH == master && ! $CDP_PULL_REQUEST_NUMBER ]]; then
        RELEASE_VERSION="$(git describe --tags --always --dirty)"
        IMAGE="registry-write.opensource.zalan.do/pathfinder/skipper:${RELEASE_VERSION}"
      else
        IMAGE="registry-write.opensource.zalan.do/pathfinder/skipper-test:${CDP_BUILD_VERSION}"
      fi
      export IMAGE
      make deps shortcheck
      git status
      git diff
      cd packaging && make docker-build && git status && git diff && make docker-push

  - desc: build-push-lightstep
    cmd: |
      git status
      git diff
      if [[ $CDP_TARGET_BRANCH == master && ! $CDP_PULL_REQUEST_NUMBER ]]; then
        RELEASE_VERSION="$(git describe --tags --always --dirty)"
        LIGHTSTEP_IMAGE="registry-write.opensource.zalan.do/pathfinder/skipper-lightstep:${RELEASE_VERSION}"
      else
        LIGHTSTEP_IMAGE="registry-write.opensource.zalan.do/pathfinder/skipper-lightstep-test:${CDP_BUILD_VERSION}"
      fi
      export LIGHTSTEP_IMAGE
      cd packaging && make docker-lightstep-build docker-lightstep-push

  - desc: build-push-opentracing
    cmd: |
      git status
      git diff
      if [[ $CDP_TARGET_BRANCH == master && ! $CDP_PULL_REQUEST_NUMBER ]]; then
        RELEASE_VERSION="$(git describe --tags --always --dirty)"
        OPENTRACING_IMAGE="registry-write.opensource.zalan.do/pathfinder/skipper-opentracing:${RELEASE_VERSION}"
      else
        OPENTRACING_IMAGE="registry-write.opensource.zalan.do/pathfinder/skipper-opentracing-test:${CDP_BUILD_VERSION}"
      fi
      export OPENTRACING_IMAGE
      cd packaging && make docker-opentracing-build docker-opentracing-push
